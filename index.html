<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Dados CSV</title>
    <meta name="author" content="Onivaldo Miquelino">          
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex justify-center">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Visualizador de Dados CSV (PHP & Chart.js)</h1>
        
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-8 text-center hover:border-indigo-500 transition duration-150">
            <label for="csvFileInput" class="cursor-pointer">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <button id="uploadBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition">
                    Selecionar Arquivo CSV
                </button>
                <p id="fileName" class="text-sm text-gray-500 mt-3">Carregue um arquivo .csv para começar a análise.</p>
            </label>
        </div>

        <div id="visualizationArea" class="hidden space-y-6">
            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Análise de Dados</h2>
            
            <div class="flex flex-wrap gap-4 items-center">
                <div class="w-full sm:w-auto">
                    <label for="labelColumn" class="block text-sm font-medium text-gray-700">Coluna de Rótulo (Eixo X):</label>
                    <select id="labelColumn" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"></select>
                </div>
                <div class="w-full sm:w-auto">
                    <label for="dataColumn" class="block text-sm font-medium text-gray-700">Coluna de Valor (Eixo Y):</label>
                    <select id="dataColumn" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"></select>
                </div>
                <div class="w-full sm:w-auto">
                    <label for="chartType" class="block text-sm font-medium text-gray-700">Tipo de Gráfico:</label>
                    <select id="chartType" class="mt-1 block w-full rounded-md border-gray-300 p-2 border">
                        <option value="bar">Barra</option>
                        <option value="line">Linha</option>
                        <option value="pie">Pizza</option>
                    </select>
                </div>
            </div>

            <div class="chart-container border p-4 rounded-lg bg-gray-50">
                <canvas id="dataChart"></canvas>
            </div>

            <div id="statusComponent" class="p-3 rounded-md bg-gray-100 text-sm text-gray-600 hidden"></div>
        </div>
    </div>

    <script>
        // ******************************************************************************
        // ATENÇÃO: Mude esta URL para o caminho correto do seu arquivo api.php no servidor
        // ******************************************************************************
        //const API_URL = 'http://localhost:8001/src/api.php'; 
        const API_URL = 'api.php'; 

        // Variável global para armazenar os dados brutos processados pelo PHP
        let currentCsvData = null;
        let chartInstance = null; // Para manter a referência do Chart.js

        // Elementos DOM
        const csvFileInput = document.getElementById('csvFileInput');
        const fileName = document.getElementById('fileName');
        const visualizationArea = document.getElementById('visualizationArea');
        const labelColumnSelect = document.getElementById('labelColumn');
        const dataColumnSelect = document.getElementById('dataColumn');
        const chartTypeSelect = document.getElementById('chartType');
        const dataChartCanvas = document.getElementById('dataChart');
        const statusComponent = document.getElementById('statusComponent');

        // --- Event Listeners ---
        csvFileInput.addEventListener('change', handleFileSelect);
        
        // Eventos para redesenhar o gráfico ao mudar as colunas/tipo
        labelColumnSelect.addEventListener('change', drawChart);
        dataColumnSelect.addEventListener('change', drawChart);
        chartTypeSelect.addEventListener('change', drawChart);

        // --- Funções Principais ---

        function updateStatus(message, type = 'info') {
            statusComponent.textContent = message;
            statusComponent.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800');
            
            if (type === 'error') {
                statusComponent.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'loading') {
                statusComponent.classList.add('bg-yellow-100', 'text-yellow-800');
            } else if (type === 'success') {
                statusComponent.classList.add('bg-green-100', 'text-green-800');
            } else {
                 statusComponent.classList.add('bg-gray-100', 'text-gray-600');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                fileName.textContent = 'Carregue um arquivo .csv para começar a análise.';
                visualizationArea.classList.add('hidden');
                return;
            }

            fileName.textContent = `Arquivo selecionado: ${file.name}`;
            updateStatus('⏳ Enviando arquivo para o PHP para processamento...', 'loading');
            
            uploadCsvToPHP(file);
        }

        async function uploadCsvToPHP(file) {
            const formData = new FormData();
            formData.append('csv_file', file);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    currentCsvData = result.data;
                    updateStatus('✅ Dados CSV processados com sucesso!', 'success');
                    setupControls(currentCsvData.headers);
                    visualizationArea.classList.remove('hidden');
                    drawChart();
                } else {
                    throw new Error(result.error || 'Erro desconhecido no servidor.');
                }
            } catch (error) {
                updateStatus(`❌ Erro de processamento: ${error.message}`, 'error');
                currentCsvData = null;
                visualizationArea.classList.add('hidden');
            }
        }
        
        // --- Setup e Gráfico ---

        function setupControls(headers) {
            labelColumnSelect.innerHTML = '';
            dataColumnSelect.innerHTML = '';

            headers.forEach(header => {
                const optionLabel = new Option(header.toUpperCase(), header);
                const optionData = new Option(header.toUpperCase(), header);
                
                labelColumnSelect.add(optionLabel);
                dataColumnSelect.add(optionData);
            });
            
            // Tenta selecionar colunas iniciais mais lógicas (ex: 1ª para rótulo, 2ª para dados)
            if (headers.length > 0) labelColumnSelect.selectedIndex = 0;
            if (headers.length > 1) dataColumnSelect.selectedIndex = 1;
            
             // Redesenha após setup
             drawChart();
        }

        function drawChart() {
            if (!currentCsvData) return;

            const labelColumn = labelColumnSelect.value;
            const dataColumn = dataColumnSelect.value;
            const chartType = chartTypeSelect.value;

            const labels = currentCsvData.data.map(row => row[labelColumn]);
            const values = currentCsvData.data.map(row => row[dataColumn]);
            
            // Destrói a instância anterior do Chart.js, se existir
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const randomColor = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.8)`;
            
            const chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: dataColumn.toUpperCase(),
                        data: values,
                        backgroundColor: chartType === 'pie' || chartType === 'doughnut' ? labels.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`) : randomColor,
                        borderColor: chartType === 'line' ? randomColor : 'white',
                        borderWidth: 1,
                        fill: chartType === 'line' ? false : true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            // Remove escalas Y para gráficos de Pizza
            if (chartType === 'pie' || chartType === 'doughnut') {
                delete chartConfig.options.scales;
            }
            
            chartInstance = new Chart(dataChartCanvas, chartConfig);
        }
        
        // --- Exemplo de Arquivo CSV para Teste (Use este conteúdo!) ---
        /*
        ID,Produto,Vendas_Mensais,Região
        1,Laptop,150,Norte
        2,Mouse,320,Sul
        3,Monitor,90,Leste
        4,Teclado,210,Oeste
        5,Câmera,80,Norte
        */
    </script>
</body>
</html>
